name: CI-CD-Pipeline-to-AWS-ElasticBeastalk
env:
  EB_S3_BUCKET_NAME   : "my-fast-api-bucket"
  EB_APPLICATION_NAME : "Myfastapi2"
  EB_ENVIRONMENT_NAME : "Myfastapi2-env"
  DEPLOY_PACKAGE_NAME : "fastapi_app_${{ github.sha }}.zip"
  AWS_REGION_NAME     : "eu-central-1"
  
on: 
  push:
    branches:
      - main

jobs:
  my_ci_part: 
    runs-on: ubuntu-latest
    
    steps:
    - name: Git clone my repos
      uses: actions/checkout@v1
    
    - name: Saving EnvData to .env
      run: |
        echo "ALGORITHMS=${{ secrets.ALGORITHMS }}" >> .env 
        echo "API_AUDIENCE=${{ secrets.API_AUDIENCE }}" >> .env 
        echo "APPHOST=${{ secrets.APPHOST }}" >> .env
        echo "APPPORT=${{ secrets.APPPORT }}" >> .env
        echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> .env
        echo "CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}" >> .env
        echo "CONNECTION=${{ secrets.CONNECTION }}" >> .env
        echo "DOMAIN=${{ secrets.DOMAIN }}" >> .env
        echo "ISSUER=${{ secrets.ISSUER }}" >> .env
        echo "MY_ALGORITHMS=${{ secrets.MY_ALGORITHMS }}" >> .env
        echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
        echo "POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}" >> .env
        echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
        echo "POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}" >> .env
        echo "POSTGRES_TEST_DB=${{ secrets.POSTGRES_TEST_DB }}" >> .env
        echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
        echo "SECRET=${{ secrets.SECRET }}" >> .env
    
    - name: Create ZIP deployment package
      run : zip -r ${{ env.DEPLOY_PACKAGE_NAME }} ./ -x *.git*
      
    - name: Configure my AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id    :  ${{ secrets.MY_AWS_ACCESS_KEY }}
        aws-secret-access-key:  ${{ secrets.MY_AWS_SECRET_KEY }}
        aws-region           :  ${{ env.AWS_REGION_NAME }}
        
    - name: Copy deploy package to S3 bucket
      run: aws s3 cp ${{ env.DEPLOY_PACKAGE_NAME }} s3://${{ env.EB_S3_BUCKET_NAME }}/
      
    - name: Print Success for CI
      run: echo "CI Part Success"
      
  my_cd_part: 
      runs-on: ubuntu-latest
      needs: [my_ci_part]
      steps: 
      - name: Configure my AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id    :  ${{ secrets.MY_AWS_ACCESS_KEY }}
          aws-secret-access-key:  ${{ secrets.MY_AWS_SECRET_KEY }}
          aws-region          :  ${{ env.AWS_REGION_NAME }}
          
      - name: Create new ElasticBeanstalk Application
        uses: einaregilsson/beanstalk-deploy@v14
        with:
          aws_access_key: ${{ secrets.MY_AWS_ACCESS_KEY }}
          aws_secret_key: ${{ secrets.MY_AWS_SECRET_KEY }}
          application_name: ${{ env.Myfastapi2 }}
          applicationName: ${{ env.Myfastapi2 }}
          environment_name: ${{ env.EB_ENVIRONMENT_NAME }}
          version_label: "ver-${{ github.sha }}"
          region: ${{ env.AWS_REGION_NAME }}
          deployment_package: ${{ env.DEPLOY_PACKAGE_NAME }}.zip
          
        
      - name: Print Success for CD
        run: echo "CD Part Success"
          
          
          
          
          
          
        
        
        
